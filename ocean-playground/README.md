# 🌊 Freshjelly's Ocean Playground - Enhanced v3.0

完全に堅牢な起動システムを備えた没入型WebGL海中体験。React Three Fiber、高度なダイブアニメーション、プロシージャル3Dオブジェクト、最先端の水中エフェクトを特徴とします。

![Ocean Playground](./public/og-ocean.jpg)

> **🛡️ Enhanced Version 3.0** - 堅牢な起動システム、8秒ウォッチドッグタイマー、セーフモードフォールバック、GLTFタイムアウト処理、ファイルプロトコル警告を搭載！

## ✨ 新機能（v3.0）

### 🛡️ 堅牢な起動システム
- **8秒ウォッチドッグタイマー**: 無限ローディングを確実に防止
- **セーフモード自動切替**: 初期化失敗時に自動でセーフモードに切り替え
- **WebGL失敗検出**: WebGLコンテキスト作成失敗を検出し、適切にフォールバック
- **プロトコル警告**: file:// で開いた場合の警告とガイダンス
- **再試行機能**: 失敗時の包括的な再試行システム

### 🎯 セーフモード機能
- ポストプロセッシング効果無効化（Bloom、Vignette、Chromatic Aberration）
- 泡の数削減: 60個（デスクトップ）/ 30個（モバイル）← 通常150個
- オブジェクト数簡素化: メイン2個/装飾3個 ← 通常3個/15個
- 固定ピクセル比（dpr=1）とアンチエイリアシング無効
- プロシージャルオブジェクトのみ（GLTFロードスキップ）

### 📡 GLTF セーフローダー
- **5秒タイムアウト**: GLTFロードに制限時間設定
- **プロシージャルフォールバック**: GLTF失敗時に自動でプロシージャル生成
- **バッチローディング**: 複数ファイルの効率的な一括ロード
- **存在チェック**: ファイル存在確認後のスマートロード

### 🔄 StrictMode対応
- **初期化ガード**: React StrictModeの二重初期化を防止
- **GSAP保護**: タイムライン重複作成を防ぐガードシステム
- **メモリリーク防止**: 適切なクリーンアップとリソース管理

## 🚀 クイックスタート

### 前提条件
- Node.js (version 18以上)
- npm または yarn

### インストール
```bash
# プロジェクトをクローンまたはダウンロード
cd ocean-playground

# 依存関係をインストール
npm install

# 開発サーバーを開始
npm run dev

# ブラウザで開く
# http://localhost:5173 にアクセス
```

### 本番ビルド
```bash
# 本番ビルドを作成
npm run build

# 本番ビルドをプレビュー
npm run preview
```

## 🎮 操作方法

### 🌊 ダイブコントロール
- **Diveボタン**: 水面から水中深部への潜行開始（右下角）
- **Surfaceボタン**: 水中深部から水面への浮上
- **スクロールでダイブ**: 初回マウスホイールスクロールで自動ダイブ（reduced-motionでは無効化可能）
- **自動スキップ**: `prefers-reduced-motion` ユーザーは浅い深度（40%）で開始

### ⌨️ キーボードショートカット
- **`R` キー**: 新しいランダムシードでオブジェクトレイアウト再生成
- **`H` キー**: UI表示切替（全インターフェース要素の表示/非表示）
- **`L` キー**: 低電力モード切替（エフェクトとジオメトリ削減）
- **`ESC` キー**: 開いているパネルを閉じる（About、Works、Contact）

### 🎯 オブジェクトインタラクション
- **ホバー/タッチ**: 水中時にバイリンガル説明表示（英語＋日本語）
- **オブジェクトクリック**: クリックしたオブジェクト周辺で泡のバースト効果
- **近接ラベル**: 十分な深度（25%以上）でダイブした時のみラベル表示
- **スケールアニメーション**: ホバー/フォーカス時のGSAPスムーズスケール

## 🏗️ プロジェクト構造

```
ocean-playground/
├── src/
│   ├── components/
│   │   ├── Scene.tsx                    # メインシーン（8秒ウォッチドッグ付き）
│   │   ├── DiveSystem.tsx               # StrictMode保護付きダイブシステム
│   │   ├── EnhancedBubbleSystem.jsx     # InstancedMesh泡システム（150個）
│   │   ├── EnhancedOceanSurface.jsx     # 深度対応水面シェーダー
│   │   ├── SafeObjectsCluster.tsx       # セーフGLTFローダー付きオブジェクト
│   │   ├── PostProcessingEffects.jsx    # Bloom、Vignette、ChromaticAberration
│   │   ├── objects/                     # セーフオブジェクト（GLTFフォールバック付き）
│   │   │   ├── safeLoadGLTF.ts         # GLTFセーフローダーユーティリティ
│   │   │   ├── SafeGlassBottle.tsx     # ガラス瓶（GLTF→プロシージャル）
│   │   │   ├── SafeTreasureChest.tsx   # 宝箱（GLTF→プロシージャル）
│   │   │   └── SafeFloatRing.tsx       # 浮き輪（GLTF→プロシージャル）
│   │   └── ui/                          # 強化UIシステム
│   │       ├── Overlay.tsx             # メインUI（ブートローダー付き）
│   │       └── panels/                 # モーダルパネル
│   ├── state/
│   │   └── useAppState.ts              # TypeScript Zustandストア（ブート状態付き）
│   ├── utils/
│   │   └── withTimeout.ts              # タイムアウトユーティリティ
│   ├── App.tsx                         # TypeScriptメインアプリ
│   ├── main.tsx                        # StrictMode付きエントリーポイント
│   └── index.css                       # グローバルスタイル
├── public/                             # 静的アセット
├── index.html                          # HTMLテンプレート
├── package.json                        # 依存関係
├── vite.config.js                      # Vite設定
└── README.md                           # この包括的なドキュメント
```

## 🛠️ 技術詳細

### コアテクノロジー
- **React 18**: 同時実行機能とSuspense付きモダンReact
- **React Three Fiber**: Three.jsのReact宣言的レンダラー
- **@react-three/drei**: 拡張コンポーネントライブラリ
- **@react-three/postprocessing**: プロ仕様ポストプロセッシング
- **Three.js 0.158+**: WebGL2対応最新3Dグラフィクスライブラリ
- **GSAP 3.12**: タイムライン制御付きプロ仕様アニメーションライブラリ
- **Zustand 4.4**: セレクターと永続化付き軽量状態管理
- **TypeScript 5.0**: 型安全性と開発者体験向上
- **Vite 5.0**: 最適化バンドル付き超高速ビルドツール

### 🛡️ 堅牢性機能
- **8秒ウォッチドッグタイマー**: 確実な起動完了保証
- **WebGL失敗検出**: コンテキスト作成テストと自動フォールバック
- **GLTFタイムアウト**: 5秒制限付きアセットロード
- **プロシージャルフォールバック**: GLTF失敗時の自動代替生成
- **StrictMode保護**: 二重初期化防止ガード
- **メモリ管理**: ジオメトリ、マテリアル、テクスチャの適切なクリーンアップ

### 🎨 高度なシェーダー＆エフェクト
- **多重オクターブ海洋シェーダー**: リアルな波パターンのための複数ノイズレイヤー
- **深度対応マテリアル**: ダイブ深度に応じた水色と不透明度変化
- **フレネル反射**: 視角に基づくリアルな水面反射
- **コースティクスシミュレーション**: アニメーション付き水中光パターン
- **ポストプロセッシングパイプライン**:
  - 輝度閾値付きBloom（PCのみ）
  - 深度ベース動的Vignette（0.05 → 0.14）
  - 水中歪み用微細Chromatic Aberration

## 🚨 トラブルシューティング

### 🔧 よくある問題と解決方法

**🛡️ セーフモードが起動する**
- 8秒以内に初期化が完了しなかった場合の正常動作
- WebGL初期化またはGLTFロードが失敗した場合
- 「Retry」ボタンで通常モードを再試行可能
- セーフモードでも完全に動作（エフェクト削減版）

**🌊 ダイブアニメーションが動作しない**
- `prefers-reduced-motion` が有効な場合（40%深度で開始する仕様）
- JavaScriptが有効でGSAPが正常にロードされているか確認
- スクロールではなく「Dive」ボタンを試す
- ブートが完了してから（8秒以内）ダイブ可能

**📱 モバイル性能が悪い**
- 低電力モードが自動有効化 - `L`キーまたはボタンで切替
- 他のブラウザタブやアプリを閉じてメモリを確保
- ブラウザキャッシュをクリアして再試行
- ブラウザ設定でハードウェアアクセラレーションが有効か確認

**🎮 コントロールが反応しない**
- WebGLがサポートされ有効になっているか確認
- プライベート/シークレットモードで拡張機能を除外して試行
- ブラウザコンソールでエラーを確認（F12 → Console）
- タッチ/マウスイベントが他の要素によってブロックされていないか確認

**⚠️ file:// プロトコル警告**
- `npm run dev` を実行して http://localhost:5173 から開く
- 直接HTMLファイルを開かず、必ず開発サーバーを使用
- モジュール読み込みには必ずHTTPサーバーが必要

## 📋 動作確認チェックリスト

### ✅ 基本動作確認
- [ ] `npm install` が正常に完了する
- [ ] `npm run dev` でサーバーが起動する
- [ ] 8秒以内にローディング画面が消える
- [ ] 3D海洋シーンが表示される
- [ ] ダイブボタンが機能する
- [ ] キーボードショートカット（R/H/L/ESC）が動作する

### ✅ エラーハンドリング確認
- [ ] file:// で開いた場合に警告バナーが表示される
- [ ] GLTFファイルが存在しない場合にプロシージャルオブジェクトが表示される
- [ ] WebGL無効時にエラーパネルが表示される
- [ ] セーフモードが適切に機能する
- [ ] エラー発生時に「Retry」ボタンが機能する

### ✅ パフォーマンス確認
- [ ] モバイルで低電力モードが自動有効化される
- [ ] セーフモードで泡数が削減される（60個以下）
- [ ] ポストプロセッシング効果がセーフモードで無効化される
- [ ] StrictModeで二重初期化が発生しない

## 🤝 貢献

### 開発
1. リポジトリをフォーク
2. フィーチャーブランチを作成
3. 変更を実装
4. デスクトップとモバイルで徹底テスト
5. プルリクエストを送信

### 貢献アイデア
- 新しいプロシージャル3Dオブジェクト
- 追加のシェーダーエフェクトと視覚改善
- パフォーマンス最適化
- アクセシビリティ強化
- 新しいUIパネルや機能

## 🔗 リンク

- [Three.js Documentation](https://threejs.org/docs/)
- [React Three Fiber](https://docs.pmnd.rs/react-three-fiber)
- [GSAP Documentation](https://greensock.com/docs/)
- [Zustand Documentation](https://docs.pmnd.rs/zustand)

---

🌊 **堅牢で美しい海の深みへダイブし、創造性の海を探索しましょう！**

*Built with ☕ and endless fascination with the ocean by Freshjelly*